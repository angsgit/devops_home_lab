---
- name: Deploy Flask app to Kubernetes
  hosts: master
  become: yes
  vars:
    app_name: webapp
    namespace_name: "{{ namespace_name | default('app-v1') }}"
    image_name: "{{ image_name | default('angsdocker/web-app:latest') }}"
    manifest_dir: /home/ubuntu/kubernetes

  tasks:
    - name: Ensure namespace exists
      shell: |
        kubectl --kubeconfig /etc/kubernetes/admin.conf get ns {{ namespace_name }} || \
        kubectl --kubeconfig /etc/kubernetes/admin.conf create ns {{ namespace_name }}

    - name: Copy Kubernetes manifests
      copy:
        src: "{{ playbook_dir }}/../../kubernetes/"
        dest: "{{ manifest_dir }}"
        owner: ubuntu
        mode: '0644'

    - name: Update image in manifest
      shell: |
        sed -i "s|image: .*|image: {{ image_name }}|g" {{ manifest_dir }}/webappv1.yaml

    - name: Apply deployment, service, and ingress
      shell: |
        kubectl --kubeconfig /etc/kubernetes/admin.conf apply -f {{ manifest_dir }}/webappv1.yaml -n {{ namespace_name }}

    - name: Wait for rollout
      shell: |
        kubectl --kubeconfig /etc/kubernetes/admin.conf rollout status deployment/{{ app_name }} -n {{ namespace_name }} --timeout=120s

    - name: Wait for Ingress to get hostname
      shell: |
        for i in {1..30}; do
          host=$(kubectl --kubeconfig /etc/kubernetes/admin.conf get ingress {{ app_name }} -n {{ namespace_name }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null)
          if [ -n "$host" ]; then echo $host; exit 0; fi
          echo "Waiting for Ingress hostname... ($i/30)"
          sleep 5
        done
        exit 1
      register: ingress_host
      retries: 5
      delay: 5
      ignore_errors: true

    - debug:
        msg: >
          ğŸŒ Access your app via Ingress at:
          http://{{ ingress_host.stdout | default('Ingress hostname not yet available') }}
